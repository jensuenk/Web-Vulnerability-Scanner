import { Component, ElementRef, ViewChild } from '@angular/core';
import { ScanInputService } from './scan-input.service'
import { MessageService } from 'primeng/api';
import { interval } from 'rxjs';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css'],
  providers: [MessageService]
})
export class AppComponent {
  @ViewChild('section') public section: ElementRef;

  title = 'website-scanner';

  url: string;
  validUrl: boolean = false;

  scanCompleted: boolean = false;
  displayModal: boolean;

  source = interval(1000);

  constructor(private scanInputService: ScanInputService, private messageService: MessageService) {
  }

  showError() {
    this.messageService.add({ severity: 'error', summary: 'Invalid URL', detail: 'This URL is invalid, please check for spelling.' });
  }

  startScan() {
    this.scanInputService.getRequest(this.url).subscribe(
      result => {
        this.validUrl = true;
      },
      error => {
        if (error.status == 200 || error.status == 201 || error.status == 202 || error.status == 203 || error.status == 204 || error.status == 205 || error.status == 206 || error.status == 207) {
          this.scanInputService.url = this.url;
          this.validUrl = true;
          this.loading();
        }
        else {
          this.validUrl = false;
          this.showError();
        }
      }
    );
  }

  loading() {
    this.displayModal = true;
    const subscribe = this.source.subscribe(val => {
      if (this.scanInputService.isScanReady()) {
        this.scanCompleted = true;
        this.displayModal = false;
        this.moveToScanSection();
        subscribe.unsubscribe();
      }
    });
  }

  moveToScanSection() {
    this.section.nativeElement.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'start' });
  }
}


