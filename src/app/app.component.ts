import { Component, ElementRef, OnInit, ViewChild } from '@angular/core';
import { ScanInputService } from './scan-input.service'
import { Message, MessageService } from 'primeng/api';
import { interval } from 'rxjs';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css'],
  providers: [MessageService]
})
export class AppComponent implements OnInit {
  @ViewChild('section') public section: ElementRef;

  title = 'website-scanner';

  url: string;
  showResults: boolean = false;

  scanCompleted: boolean = false;
  displayModal: boolean;

  source = interval(1000);

  captcha: boolean = false;
  
  msgs: Message[];

  constructor(private scanInputService: ScanInputService, private messageService: MessageService) {
  }

  ngOnInit(): void {    
    this.msgs = [{severity:'info', summary:'CORS', detail:"Please make sure you have CORS disabled or this website won't work. For Safari: go to Develop -> Disable Cross-Origin Restrictions, For Chrome: instal an extension like https://bit.ly/3i3htW0"}]

  }

  startScan() {
    this.showResults = false;
    if (!this.captcha) {
      this.messageService.add({ severity: 'error', summary: 'Captcha required', detail: 'Please complete the captcha before starting a scan!' });
      return;
    }
    if (!(this.url.startsWith("http://") || this.url.startsWith("https://"))) {
      this.url = 'https://' + this.url;
    }
    this.scanInputService.getRequest(this.url).subscribe(
      result => {
        this.scanInputService.url = this.url;
        this.showResults = true;
        this.loading();
      },
      error => {
        console.log(error)
        if (error.status == 200 || error.status == 201 || error.status == 202 || error.status == 203 || error.status == 204 || error.status == 205 || error.status == 206 || error.status == 207) {
          this.scanInputService.url = this.url;
          this.showResults = true;
          this.loading();
        }
        else {
          this.showResults = false;
          this.messageService.add({ severity: 'error', summary: 'Invalid URL', detail: "This URL is invalid or you don't have CORS disabled." });
        }
      }
    );
  }

  loading() {
    this.displayModal = true;
    const subscribe = this.source.subscribe(val => {
      if (this.scanInputService.isScanReady()) {
        this.scanCompleted = true;
        this.displayModal = false;
        this.moveToScanSection();
        subscribe.unsubscribe();
        this.messageService.add({ severity: 'success', summary: 'Scan completed', detail: 'Successfull analyzed the website ' + this.url + '.' });
      }
    });
  }

  moveToScanSection() {
    this.section.nativeElement.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'start' });
  }

  showResponse(event) {
    this.messageService.add({ severity: 'info', summary: 'Captcha success', detail: 'You completed the captcha, you may now start a scan' });
    this.captcha = true;
  }
}


