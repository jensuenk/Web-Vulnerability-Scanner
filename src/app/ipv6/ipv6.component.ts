import { Component, OnInit } from '@angular/core';
import { ScanInputService } from '../scan-input.service';
import { HttpClient } from '@angular/common/http';
import { htmlAstToRender3Ast } from '@angular/compiler/src/render3/r3_template_transform';
import { WebscrapeService } from './webscrape.service';


@Component({
  selector: 'app-ipv6',
  templateUrl: './ipv6.component.html',
  styleUrls: ['./ipv6.component.css']
})
export class Ipv6Component implements OnInit {

  html: string;
  testNames: string[] = ['DNS (IPv6 NS)', 'DNS (IPv6 TLD NS)', 'DNS (IPv4 A Record)', 'DNS (IPv6 AAAA Record)', 'DNS (MX Record)', 'DNS (Glue)', 'IPv4 Connectivity', 'IPv6 Connectivity', 'IPv4 Literals']
  testResults: string[] = []
  resultDescriptions: string[] = []

  tests: IPTest[] = []

  constructor(
    private http: HttpClient,
    private scanInputService: ScanInputService
  ) { }

  ngOnInit(): void {
    this.getHtmlFromUrl()
  }

  getHtmlFromUrl() {
    var checkerURL = "https://ready.chair6.net/?url=" + encodeURI(this.scanInputService.url);
    this.http.get(checkerURL, { responseType: "text" }).subscribe(data => {
      this.html = data as string;
      this.getDataFromHtml()
      console.log(this.tests)
    });
  }

  getDataFromHtml() {
    this.testNames.forEach(element => {
      var index = this.testNames.indexOf(element)
      var searchString = element;
      var searchPos = this.html.indexOf(searchString)
      var startPos = searchPos + searchString.length + 40;
      var result = this.html.slice(startPos, startPos + 4)
      this.testResults.push(result)
      var descriptionStartPos = startPos + 44;
      var descriptionResult = this.html.slice(descriptionStartPos, descriptionStartPos + 120)
      var onlyDescriptionResult = descriptionResult.split('<')[0]
      this.resultDescriptions.push(onlyDescriptionResult)
      this.tests.push(new IPTest(element, result, onlyDescriptionResult))
    });
  }
}

class IPTest {
  testName: string
  testResult: string
  descriptionResult: string

  constructor(testNameIn: string, testResultIn: string, descriptionResultIn: string) {
    this.testName = testNameIn;
    this.testResult = testResultIn;
    this.descriptionResult = descriptionResultIn;
  }
}