import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class WappalyzerService {

  key: string = 'fKecE6HgNu2FgRMSE0MzzoO1f5rfo8B81Bql1Vsj';
  technologies: Technology[];
  error: string;

  constructor(private http: HttpClient) {
  }

  getResponse(url: string): Observable<any> {
    const headers = new HttpHeaders()
      .set('x-api-key', this.key)
      .set('Content-Type', 'application/json');

    return this.http.get<any>("https://api.wappalyzer.com/lookup/v2/?urls=" + url, { headers: headers });
  }

  getTechnologies(url: string) {
    this.getResponse(url).subscribe(
      result => {
        result.forEach(element => {
          this.technologies = element.technologies;
        });
        console.log(this.technologies)
        if (this.technologies.length > 0) {
          this.error = "Could not retreive the used server software from this url. Make sure your url is correct.";
        }
      },
      error => {
        this.error = error.message;
      }
    );
  }
}

export interface Category {
  id: number;
  slug: string;
  name: string;
}

export interface Technology {
  slug: string;
  name: string;
  confidence: number;
  version?: any;
  icon: string;
  website: string;
  cpe: string;
  categories: Category[];
}

export interface RootObject {
  urls: any;
  technologies: Technology[];
}